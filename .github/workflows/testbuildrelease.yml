# https://github.com/marketplace/actions/release-please-action
# https://www.conventionalcommits.org/en/v1.0.0/
# https://docs.github.com/en/repositories/releasing-projects-on-github/automatically-generated-release-notes
# https://docs.github.com/en/actions

name: Test, Build and Release
on:
    workflow_dispatch:
    push:
        branches: [main, develop]

jobs:
    test:
      name: run all unit tests
      runs-on: ubuntu-latest
      steps:
        - name: CheckOut repository
          uses: actions/checkout@v3

        - name: Enable cache
          uses: actions/cache@v3
          with:
            path: |
              ~/.cache/pip
              ~/.platformio/.cache
            key: ${{ runner.os }}-pio

        - name: Install Python 3.9
          uses: actions/setup-python@v4
          with:
            python-version: '3.9'

        - name: Install PlatformIO Core
          run: pip install --upgrade platformio

        - name: Run all generic unit tests
          run: pio test -e generic_all_tests

    build:
      needs: test
      name: build a binary
      runs-on: ubuntu-latest
      steps:
        - name: CheckOut repository
          uses: actions/checkout@v3

        - name: Enable cache
          uses: actions/cache@v3
          with:
            path: |
              ~/.cache/pip
              ~/.platformio/.cache
            key: ${{ runner.os }}-pio

        - name: Install Python 3.9
          uses: actions/setup-python@v4
          with:
            python-version: '3.9'

        - name: Install PlatformIO Core
          run: pip install --upgrade platformio

        - name: Build
          run: pio run -e mumo_v2x_pcb
